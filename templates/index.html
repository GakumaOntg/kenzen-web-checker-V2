<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" data-theme-color="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garena Account Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --bs-primary: #0d6efd;
            --bs-primary-rgb: 13, 110, 253;
            /* Custom Appearance Variables with Fallbacks */
            --body-bg: #121212;
            --card-bg: #1e1e1e;
            --logs-bg: #0c0c0c;
            --highlight-color: #dc3545;
        }
        /* Theme Overrides */
        html[data-theme-color="danger"] { --bs-primary: #dc3545; --bs-primary-rgb: 220, 53, 69; }
        html[data-theme-color="success"] { --bs-primary: #28a745; --bs-primary-rgb: 40, 167, 69; }
        html[data-theme-color="warning"] { --bs-primary: #ffc107; --bs-primary-rgb: 255, 193, 7; }

        body {
            background-color: var(--body-bg);
            color: #e0e0e0;
            padding-top: 60px; /* Space for fixed navbar */
        }
        .container-fluid {
            max-width: 1600px;
        }
        .navbar {
            background-color: var(--card-bg);
            border-bottom: 1px solid #333;
        }
        .banner {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre;
            color: #888;
            text-align: center;
            font-size: 0.9em;
            line-height: 1.1;
            padding: 1rem 0;
            overflow-x: auto;
        }
        .banner .highlight { 
            color: var(--highlight-color);
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid #333;
        }
        .form-control, .form-select, .form-control:disabled {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border-color: #444;
        }
        .form-control:focus, .form-select:focus {
            background-color: #333;
            color: #fff;
            border-color: var(--bs-primary); /* Use theme color */
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
        }
        .nav-pills .nav-link { color: #ccc; }
        .nav-pills .nav-link.active { background-color: var(--bs-primary); color: #fff; }

        input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 100%; height: 38px; padding: 0; border: 1px solid #444;
            border-radius: 0.375rem; background-color: transparent; cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch { border-radius: 0.375rem; border: none; }
        input[type="color"]::-moz-color-swatch { border-radius: 0.375rem; border: none; }
        .progress-bar, .btn-primary {
             background-color: var(--bs-primary); border-color: var(--bs-primary);
        }
        html[data-theme-color="warning"] .btn-primary { color: #000; }
        html[data-theme-color="warning"] .btn-primary:hover { color: #000; }
        #logs-container {
            height: 60vh;
            background-color: var(--logs-bg);
            border: 1px solid #333;
            padding: 10px;
            overflow-y: scroll;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-line { display: flex; }
        .log-line .timestamp { color: #888; margin-right: 10px; flex-shrink: 0; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .text-success { color: #28a745 !important; } .text-danger { color: #dc3545 !important; }
        .text-warning { color: #ffc107 !important; } .text-info { color: #17a2b8 !important; }

        #captcha-modal { background-color: rgba(0,0,0,0.7); }
        .modal-footer { flex-wrap: wrap; }
        .captcha-action-btn { margin: 5px; }

        .admin-table { font-size: 0.8em; }
        .admin-table th, .admin-table td { padding: 0.4rem; }
        .table-responsive { max-height: 250px; }

        .offcanvas { background-color: var(--card-bg); }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
                <i class="bi bi-list"></i> Menu
            </button>
            <a class="navbar-brand mx-auto" href="#">Garena Account Checker</a>
            <div class="d-flex align-items-center">
                 {% if user.upgraded %}
                    <span class="badge bg-success d-none d-sm-inline-block"><i class="bi bi-star-fill"></i> Upgraded</span>
                {% else %}
                    <span class="badge bg-secondary d-none d-sm-inline-block">Free Tier</span>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm ms-2"><i class="bi bi-box-arrow-right"></i></a>
            </div>
        </div>
    </nav>

    <!-- Sidebar (Offcanvas) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header border-bottom border-secondary">
            <h5 class="offcanvas-title" id="sidebarLabel">
                <i class="bi bi-person-circle"></i> {{ user.username }}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            
            <!-- Sidebar Navigation -->
            <ul class="nav nav-pills nav-fill mb-3" id="sidebar-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="controls-tab-btn" data-bs-toggle="pill" data-bs-target="#controls-tab" type="button" role="tab" aria-controls="controls-tab" aria-selected="true"><i class="bi bi-controller"></i> Controls</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab-btn" data-bs-toggle="pill" data-bs-target="#settings-tab" type="button" role="tab" aria-controls="settings-tab" aria-selected="false"><i class="bi bi-gear"></i> Settings</button>
                </li>
                {% if user.username == 'admin' %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admin-tab-btn" data-bs-toggle="pill" data-bs-target="#admin-tab" type="button" role="tab" aria-controls="admin-tab" aria-selected="false"><i class="bi bi-shield-lock"></i> Admin</button>
                </li>
                {% endif %}
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="sidebar-tab-content">
                
                <!-- Controls Tab -->
                <div class="tab-pane fade show active" id="controls-tab" role="tabpanel" aria-labelledby="controls-tab-btn">
                    <h5 class="mb-3"><i class="bi bi-play-circle-fill"></i> Checker Controls</h5>
                    <form id="start-form" action="{{ url_for('start_check') }}" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="account_file" class="form-label">Account File (.txt)</label>
                            <input class="form-control" type="file" id="account_file" name="account_file" required>
                            {% if not user.upgraded %}
                            <div class="form-text text-warning">Free tier is limited to 100 lines.</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="cookie_module" class="form-label">Cookie Module</label>
                            <select class="form-select" id="cookie_module" name="cookie_module">
                                <option value="ken_cookie" selected>Ken Cookie</option>
                                <option value="change_cookie">Change Cookie (Enhanced)</option>
                                <option value="set_cookie">Numbered Set (from config)</option>
                            </select>
                        </div>
                        <div class="mb-3" id="cookie-number-input-wrapper" style="display: none;">
                            <label for="cookie_number_input" class="form-label">Use Fixed Cookie Number</label>
                            <input type="number" class="form-control" id="cookie_number_input" name="cookie_number" min="1" placeholder="e.g., 200 (optional)">
                            <div class="form-text">Leave empty to cycle through all cookies in the set.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Telegram Notifications</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="bi bi-robot"></i></span>
                                <input type="text" class="form-control" name="telegram_bot_token" placeholder="Bot Token" value="{{ bot_token }}">
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="bi bi-person"></i></span>
                                <input type="text" class="form-control" name="telegram_chat_id" placeholder="Chat ID" value="{{ chat_id }}">
                            </div>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-filter-circle"></i></span>
                                <select class="form-select" id="telegram_level_filter" name="telegram_level_filter">
                                    <option value="all" selected>Send All Levels</option>
                                    <option value="100+">Send Level 100+</option>
                                    <option value="none">Disable Telegram</option>
                                </select>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="save_telegram_creds" id="save_telegram_creds" checked>
                                <label class="form-check-label" for="save_telegram_creds">Save credentials for this session</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="use_cookie_set" name="use_cookie_set">
                                <label class="form-check-label" for="use_cookie_set">Use hardcoded cookies</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="auto_delete" name="auto_delete">
                                <label class="form-check-label" for="auto_delete">Delete file on completion</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="force_restart" name="force_restart">
                                <label class="form-check-label" for="force_restart">Start from beginning</label>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" id="start-btn" class="btn btn-primary"><i class="bi bi-play-circle-fill"></i> Start Checker</button>
                            <button type="button" id="stop-btn" class="btn btn-danger" style="display: none;"><i class="bi bi-stop-circle-fill"></i> Stop Checker</button>
                        </div>
                    </form>
                </div>
                
                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings-tab" role="tabpanel" aria-labelledby="settings-tab-btn">
                     {% if not user.upgraded %}
                    <div class="card bg-dark border-secondary mb-3">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-gem me-2"></i> Upgrade Account</h5>
                            <p class="small">Redeem a key to unlock unlimited checking.</p>
                            <form action="{{ url_for('redeem_key') }}" method="POST">
                                <div class="input-group">
                                    <input type="text" name="key" class="form-control" placeholder="Enter redemption key" required>
                                    <button class="btn btn-success" type="submit">Redeem</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                           <h5 class="card-title"><i class="bi bi-palette-fill me-2"></i> Appearance & Credits</h5>
                            <div class="mb-3">
                                <label class="form-label">Main Theme Color</label>
                                <div id="theme-selector" class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm w-100" style="background-color: #0d6efd;" data-theme="default" title="Default Blue"></button>
                                    <button type="button" class="btn btn-sm w-100" style="background-color: #dc3545;" data-theme="danger" title="Red"></button>
                                    <button type="button" class="btn btn-sm w-100" style="background-color: #28a745;" data-theme="success" title="Green"></button>
                                    <button type="button" class="btn btn-sm w-100" style="background-color: #ffc107;" data-theme="warning" title="Yellow"></button>
                                </div>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label small">Skull & Highlight</label><input type="color" id="highlight-color-picker" class="form-control" value="#dc3545"></div>
                                <div class="col-6"><label class="form-label small">Page BG</label><input type="color" id="body-bg-picker" class="form-control" value="#121212"></div>
                                <div class="col-6"><label class="form-label small">Card BG</label><input type="color" id="card-bg-picker" class="form-control" value="#1e1e1e"></div>
                                <div class="col-6"><label class="form-label small">Logs BG</label><input type="color" id="logs-bg-picker" class="form-control" value="#0c0c0c"></div>
                            </div>
                            <div class="mb-3">
                                <label for="credits-text-input" class="form-label">Credits Text</label>
                                <input type="text" class="form-control" id="credits-text-input" value="PAPA MO">
                            </div>
                            <button type="button" id="reset-appearance-btn" class="btn btn-sm btn-outline-secondary w-100">Reset Appearance</button>
                        </div>
                    </div>
                </div>

                <!-- Admin Tab -->
                {% if user.username == 'admin' %}
                <div class="tab-pane fade" id="admin-tab" role="tabpanel" aria-labelledby="admin-tab-btn">
                     <div class="d-grid mb-3">
                        <button id="generate-key-btn" class="btn btn-info"><i class="bi bi-key-fill"></i> Generate New Key</button>
                    </div>

                    <div class="card bg-dark border-secondary mb-3">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-megaphone-fill"></i> Post Announcement</h5>
                            <form id="announcement-form">
                                <div class="mb-2">
                                    <textarea id="announcement-message" class="form-control" rows="3" placeholder="Enter maintenance notice or update news..." required></textarea>
                                </div>
                                <div class="input-group">
                                    <select id="announcement-type" class="form-select">
                                        <option value="info" selected>Info (Blue)</option>
                                        <option value="success">Success (Green)</option>
                                        <option value="warning">Warning (Yellow)</option>
                                        <option value="danger">Danger (Red)</option>
                                    </select>
                                    <button type="submit" id="post-announcement-btn" class="btn btn-primary">Post</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <h6><i class="bi bi-people-fill"></i> Registered Users</h6>
                    <div class="table-responsive mb-3">
                        <table class="table table-dark table-striped admin-table">
                            <thead><tr><th>User</th><th>Email</th><th>Status</th></tr></thead>
                            <tbody id="admin-users-table"><!-- Data will be loaded by JS --></tbody>
                        </table>
                    </div>
                    <h6><i class="bi bi-ticket-detailed-fill"></i> Generated Keys</h6>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped admin-table">
                            <thead><tr><th>Key</th><th>Status</th></tr></thead>
                            <tbody id="admin-keys-table"><!-- Data will be loaded by JS --></tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div id="announcement-placeholder"></div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        
        <div class="banner">
                          :::!~!!!!!:.          
                  .xUHWH!! !!?M88WHX:.       
                .X*#M@$!!  !X!M$$$$$WWx:     
               :!!!!!!?H! :!$!$$$$$$$$$8X:  
             !!~  ~:~!! :~!$!%$$$$$$$$$$8X:  
             :!~::!H![   ~.U$X!?W$$$$$$$MM! 
             ~!~!!!!~~ .:XW$$$U!!?$$$$$$WMM! 
               !:~~~ .:!M*T#$$$$WX??#MRRMMM! 
               ~?WuxiW*     *#$$$$8!!!!??!!! 
             :X- M$$$$  <span class="highlight">ñ£ò</span>   '#T#$T~!8$WUXU~ 
          :%'  ~%$$$Mm:         ~!~ ?$$$$$$  
          :! .-   ~T$$$$8xx.  .xWW- ~‚Äù‚Äù##*'' 
  .....   -~~:&lt;  !    ~?T$@@W@*?$$ <span class="highlight">ñ£ò</span> /‚Äô   
 W$@@M!!! .!~~ !!     .:XUW$W!~ '*~:   :     
 %^~~'.:x%'!!  !H:   !WM$$$$Ti.: .!WUnn!     
 :::~:!. :X~ .: ?H.!u *$$$$$$$!W:U!T$$M~     
 .~~   :X@!.-~   ?@WTWo('*$$$W$TH$!          
 Wi.~!X$?!-~    : ?$$$B$Wu(***$RM!           
 $R@i.#~ !     :   -$$$$$%$Mm$;              
 ?MXT@Wx.~    :     ~##$$$$M~                
<span class="highlight" id="credits-span">           ÓÇ≤ÔÉß ùêèùê´ùêûùê¨ùêûùêßùê≠ùêûùêù ùêÅùê≤: PAPA MO ÔÉßÓòÇ</span>
        </div>

        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-terminal-fill"></i> Live Status</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3" role="progressbar" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                </div>
                <div class="d-flex justify-content-between mb-2 text-muted">
                    <small id="progress-text">Checked: 0 / 0</small>
                    <small id="current-account-text">Status: Idle</small>
                </div>
                <div id="stats-container" class="d-flex flex-wrap justify-content-around small p-2 rounded bg-dark mb-3">
                    <span><i class="bi bi-check-circle-fill text-success"></i> Hits: <span id="stats-hits">0</span></span>
                    <span><i class="bi bi-x-circle-fill text-danger"></i> Fails: <span id="stats-fails">0</span></span>
                    <span><i class="bi bi-key-fill text-warning"></i> Wrong Pass: <span id="stats-wrongpass">0</span></span>
                    <span><i class="bi bi-shield-fill-check text-success"></i> Clean: <span id="stats-clean">0</span></span>
                    <span><i class="bi bi-shield-fill-exclamation text-warning"></i> Not Clean: <span id="stats-notclean">0</span></span>
                    <span><i class="bi bi-send-fill text-info"></i> TG Sent: <span id="stats-tgsent">0</span></span>
                    <span><i class="bi bi-robot text-danger"></i> CAPTCHA: <span id="stats-captcha">0</span></span>
                </div>
                <div id="logs-container"></div>
            </div>
        </div>
    </div>

    <!-- CAPTCHA Modal -->
    <div class="modal fade" id="captcha-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-lock-fill"></i> CAPTCHA Detected</h5>
                </div>
                <div class="modal-body">
                    <p>The checker is paused. The current cookie was blocked and has been put on a 5-minute cooldown.</p>
                    <p>Please choose an action:</p>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary captcha-action-btn" data-action="next_cookie"><i class="bi bi-arrow-right-circle"></i> Try Next Cookie</button>
                    <button type="button" class="btn btn-primary captcha-action-btn" data-action="fetch_pool"><i class="bi bi-cloud-download-fill"></i> Fetch New Cookies</button>
                    <button type="button" class="btn btn-warning captcha-action-btn" data-action="retry_ip"><i class="bi bi-globe"></i> I Changed My IP/VPN</button>
                    <button type="button" class="btn btn-danger captcha-action-btn" data-action="stop_checker"><i class="bi bi-stop-circle-fill"></i> Stop & Exit</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Main UI elements
            const startForm = document.getElementById('start-form');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const logsContainer = document.getElementById('logs-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const currentAccountText = document.getElementById('current-account-text');
            const statsHits = document.getElementById('stats-hits');
            const statsFails = document.getElementById('stats-fails');
            const statsWrongPass = document.getElementById('stats-wrongpass');
            const statsClean = document.getElementById('stats-clean');
            const statsNotClean = document.getElementById('stats-notclean');
            const statsTgSent = document.getElementById('stats-tgsent');
            const statsCaptcha = document.getElementById('stats-captcha');
            const captchaModal = new bootstrap.Modal(document.getElementById('captcha-modal'));
            
            // Appearance and Credits Elements
            const htmlElement = document.documentElement;
            const themeButtons = document.querySelectorAll('#theme-selector button');
            const highlightColorPicker = document.getElementById('highlight-color-picker');
            const bodyBgPicker = document.getElementById('body-bg-picker');
            const cardBgPicker = document.getElementById('card-bg-picker');
            const logsBgPicker = document.getElementById('logs-bg-picker');
            const creditsTextInput = document.getElementById('credits-text-input');
            const creditsSpan = document.getElementById('credits-span');
            const resetAppearanceBtn = document.getElementById('reset-appearance-btn');
            
            const cookieModuleSelect = document.getElementById('cookie_module');
            const cookieNumberWrapper = document.getElementById('cookie-number-input-wrapper');

            // Admin Panel Elements
            const generateKeyBtn = document.getElementById('generate-key-btn');
            const adminUsersTable = document.getElementById('admin-users-table');
            const adminKeysTable = document.getElementById('admin-keys-table');
            const announcementForm = document.getElementById('announcement-form');
            const announcementPlaceholder = document.getElementById('announcement-placeholder');
            
            let statusInterval;
            let lastLogCount = 0;
            const APPEARANCE_STORAGE_KEY = 'garenaCheckerAppearance';

            // --- APPEARANCE & CREDITS LOGIC ---
            function applyAndSaveAppearance() {
                const settings = {
                    mainTheme: htmlElement.getAttribute('data-theme-color') || 'default',
                    highlightColor: highlightColorPicker.value,
                    bodyBg: bodyBgPicker.value,
                    cardBg: cardBgPicker.value,
                    logsBg: logsBgPicker.value,
                    creditsText: creditsTextInput.value
                };
                htmlElement.style.setProperty('--highlight-color', settings.highlightColor);
                htmlElement.style.setProperty('--body-bg', settings.bodyBg);
                htmlElement.style.setProperty('--card-bg', settings.cardBg);
                htmlElement.style.setProperty('--logs-bg', settings.logsBg);
                creditsSpan.textContent = `           ÓÇ≤ÔÉß ùêèùê´ùêûùê¨ùêûùêßùê≠ùêûùêù ùêÅùê≤: ${settings.creditsText} ÔÉßÓòÇ`;
                localStorage.setItem(APPEARANCE_STORAGE_KEY, JSON.stringify(settings));
            }

            function loadAppearance() {
                const savedSettings = localStorage.getItem(APPEARANCE_STORAGE_KEY);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    htmlElement.setAttribute('data-theme-color', settings.mainTheme);
                    highlightColorPicker.value = settings.highlightColor;
                    bodyBgPicker.value = settings.bodyBg;
                    cardBgPicker.value = settings.cardBg;
                    logsBgPicker.value = settings.logsBg;
                    creditsTextInput.value = settings.creditsText;
                }
                applyAndSaveAppearance();
            }
            
            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    htmlElement.setAttribute('data-theme-color', button.dataset.theme);
                    applyAndSaveAppearance();
                });
            });
            [highlightColorPicker, bodyBgPicker, cardBgPicker, logsBgPicker, creditsTextInput].forEach(el => {
                el.addEventListener('input', applyAndSaveAppearance);
            });
            resetAppearanceBtn.addEventListener('click', () => {
                localStorage.removeItem(APPEARANCE_STORAGE_KEY);
                location.reload();
            });
            
            loadAppearance();
            
            // --- COOKIE NUMBER INPUT LOGIC ---
            function toggleCookieNumberInput() {
                cookieNumberWrapper.style.display = (cookieModuleSelect.value === 'set_cookie') ? 'block' : 'none';
            }
            cookieModuleSelect.addEventListener('change', toggleCookieNumberInput);
            toggleCookieNumberInput();

            function updateUI(status) {
                if (status.running) {
                    startBtn.style.display = 'none'; stopBtn.style.display = 'block';
                    document.querySelectorAll('#sidebar input, #sidebar select, #sidebar button').forEach(el => {
                        if (el.id !== 'stop-btn') el.disabled = true;
                    });
                } else {
                    startBtn.style.display = 'block'; stopBtn.style.display = 'none';
                    document.querySelectorAll('#sidebar input, #sidebar select, #sidebar button').forEach(el => el.disabled = false);
                    if (statusInterval) { clearInterval(statusInterval); }
                }

                const progress = status.total > 0 ? (status.progress / status.total) * 100 : 0;
                progressBar.style.width = `${progress.toFixed(2)}%`;
                progressBar.textContent = `${progress.toFixed(0)}%`;
                progressText.textContent = `Checked: ${status.progress} / ${status.total}`;
                currentAccountText.textContent = `Current: ${status.current_account || 'N/A'}`;

                if (status.stats) {
                    statsHits.textContent = status.stats.successful || 0;
                    statsFails.textContent = status.stats.failed || 0;
                    statsWrongPass.textContent = status.stats.incorrect_pass || 0;
                    statsClean.textContent = status.stats.clean || 0;
                    statsNotClean.textContent = status.stats.not_clean || 0;
                    statsTgSent.textContent = status.stats.telegram_sent || 0;
                    statsCaptcha.textContent = status.stats.captcha_count || 0;
                }

                if (status.logs && status.logs.length > lastLogCount) {
                    const newLogs = status.logs.slice(lastLogCount);
                    newLogs.forEach(log => {
                        const logElement = document.createElement('div');
                        logElement.className = `log-line ${log.class}`;
                        logElement.innerHTML = `<span class="timestamp">${log.timestamp}</span><span>${log.message}</span>`;
                        logsContainer.appendChild(logElement);
                    });
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                    lastLogCount = status.logs.length;
                }
                
                if (status.captcha_detected) { captchaModal.show(); } else { captchaModal.hide(); }
                
                if(status.final_summary && !status.running) {
                    const summaryElement = document.createElement('pre');
                    summaryElement.className = 'text-success p-2 mt-2 border border-success rounded';
                    summaryElement.textContent = status.final_summary;
                    logsContainer.appendChild(summaryElement);
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
            }

            function fetchStatus() {
                fetch('/status').then(response => {
                    if (response.status === 401) { window.location.href = '/login'; return; }
                    return response.json();
                }).then(data => { if(data) updateUI(data);
                }).catch(error => { console.error('Error fetching status:', error); if (statusInterval) clearInterval(statusInterval); });
            }

            startForm.addEventListener('submit', function (e) {
                if (!document.getElementById('account_file').files.length) { e.preventDefault(); alert("Please select an account file."); return; }
                startBtn.disabled = true;
                startBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Starting...';
                setTimeout(() => { lastLogCount = 0; logsContainer.innerHTML = ''; statusInterval = setInterval(fetchStatus, 1500); }, 500);
            });

            stopBtn.addEventListener('click', function () {
                fetch('/stop_check', { method: 'POST' }).then(response => response.json()).then(data => {
                    console.log(data.message); stopBtn.disabled = true; stopBtn.textContent = "Stopping...";
                });
            });
            
            document.querySelectorAll('.captcha-action-btn').forEach(button => {
                button.addEventListener('click', function() {
                    fetch('/captcha_action', { 
                        method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: new URLSearchParams({action: this.dataset.action})
                    });
                    captchaModal.hide();
                });
            });
            
            // --- ADMIN PANEL LOGIC ---
            function loadAdminData() {
                if (!adminUsersTable || !adminKeysTable) return;
                fetch('/admin/data').then(res => res.json()).then(data => {
                    adminUsersTable.innerHTML = '';
                    data.users.forEach(user => {
                        const statusBadge = user.upgraded ? '<span class="badge bg-success">Upgraded</span>' : '<span class="badge bg-secondary">Free</span>';
                        adminUsersTable.innerHTML += `<tr><td>${user.username}</td><td>${user.email}</td><td>${statusBadge}</td></tr>`;
                    });
                    adminKeysTable.innerHTML = '';
                    data.keys.forEach(key => {
                        const status = key.redeemed_by ? `<span class="badge bg-danger">Used by ${key.redeemed_by}</span>` : '<span class="badge bg-success">Available</span>';
                        adminKeysTable.innerHTML += `<tr><td><code>${key.key}</code></td><td>${status}</td></tr>`;
                    });
                });
            }

            if (generateKeyBtn) {
                generateKeyBtn.addEventListener('click', () => {
                    generateKeyBtn.disabled = true;
                    generateKeyBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
                    fetch('/admin/generate_key', { method: 'POST' }).then(res => res.json()).then(data => {
                        if (data.status === 'success') { alert(`New Key Generated: ${data.key}`); loadAdminData(); } 
                        else { alert('Failed to generate key.'); }
                    }).finally(() => { generateKeyBtn.disabled = false; generateKeyBtn.innerHTML = '<i class="bi bi-key-fill"></i> Generate New Key'; });
                });
                document.getElementById('admin-tab-btn').addEventListener('click', loadAdminData);
            }

            if(announcementForm) {
                announcementForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const message = document.getElementById('announcement-message').value;
                    const msg_type = document.getElementById('announcement-type').value;
                    const btn = document.getElementById('post-announcement-btn');
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                    fetch('/admin/post_announcement', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message, msg_type: msg_type })
                    }).then(res => res.json()).then(data => {
                        if (data.status === 'success') {
                            alert('Announcement posted!');
                            announcementForm.reset();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    }).finally(() => { btn.disabled = false; btn.innerHTML = 'Post'; });
                });
            }

            // --- ANNOUNCEMENT FETCH LOGIC ---
            function fetchLatestAnnouncement() {
                fetch('/get_latest_announcement').then(res => res.json()).then(data => {
                    if (data && localStorage.getItem('dismissedAnnouncement') !== data.id) {
                        const alertHTML = `
                            <div class="alert alert-${data.type} alert-dismissible fade show" role="alert">
                                <strong><i class="bi bi-info-circle-fill"></i> Admin Notice:</strong> ${data.message}
                                <button type="button" class="btn-close" data-announcement-id="${data.id}" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>`;
                        announcementPlaceholder.innerHTML = alertHTML;
                        announcementPlaceholder.querySelector('.btn-close').addEventListener('click', function() {
                            localStorage.setItem('dismissedAnnouncement', this.dataset.announcementId);
                        });
                    }
                });
            }
            fetchLatestAnnouncement();

            // Initial status check
            fetchStatus();
            statusInterval = setInterval(fetchStatus, 1500);
        });
    </script>
</body>
</html>